name: Publish Packages

on:
  # Trigger after build-bindings workflow completes successfully
  workflow_run:
    workflows: ["Build Bindings"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish from (e.g., v0.0.28)'
        required: true
        type: string
      publish_csharp:
        description: 'Publish C# NuGet package'
        required: false
        type: boolean
        default: true
      publish_web:
        description: 'Publish Web npm package'
        required: false
        type: boolean
        default: true
      publish_react_native:
        description: 'Publish React Native npm package'
        required: false
        type: boolean
        default: true
      publish_crates_io:
        description: 'Publish Rust crate to crates.io'
        required: false
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Check if workflow_run was successful before proceeding
  check-workflow:
    if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.get-tag.outputs.tag }}
      should_run: ${{ steps.check.outputs.should_run }}
    
    steps:
    - name: Check workflow_run conclusion
      id: check
      run: |
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "Build Bindings workflow did not succeed. Skipping publish."
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Get release tag
      id: get-tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.release_tag }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using manually specified release tag: $TAG"
        else
          # For workflow_run, get the latest release tag
          echo "ðŸ” Looking for latest release..."
          TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "âŒ ERROR: No release found in the repository"
            echo ""
            echo "To publish packages, you need to:"
            echo "1. Create a GitHub Release (e.g., v0.0.28)"
            echo "2. Run the 'Build Bindings' workflow to upload packages to that release"
            echo "3. Then run this publish workflow"
            echo ""
            echo "Or use workflow_dispatch and manually specify the release tag."
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Found latest release: $TAG"
        fi
  
  # Download pre-built packages from GitHub Release
  download-release-assets:
    needs: check-workflow
    if: needs.check-workflow.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify release exists
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ needs.check-workflow.outputs.release_tag }}"
        echo "Checking if release $TAG exists..."
        
        if ! gh release view "$TAG" > /dev/null 2>&1; then
          echo "âŒ ERROR: Release $TAG does not exist"
          echo "Available releases:"
          gh release list --limit 5
          exit 1
        fi
        
        echo "âœ… Release $TAG found"
        echo ""
        echo "Release info:"
        gh release view "$TAG"
    
    - name: Download release assets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ needs.check-workflow.outputs.release_tag }}"
        echo "Downloading assets from release: $TAG"
        
        # Create download directory
        mkdir -p release-assets
        cd release-assets
        
        # Download all release assets
        echo "Downloading .nupkg files..."
        gh release download "$TAG" --pattern "*.nupkg" || echo "âš ï¸ No .nupkg files found"
        
        echo "Downloading .tgz files..."
        gh release download "$TAG" --pattern "*.tgz" || echo "âš ï¸ No .tgz files found"
        
        echo "Downloading .tar.gz files..."
        gh release download "$TAG" --pattern "*.tar.gz" || echo "âš ï¸ No .tar.gz files found"
    
    - name: Verify downloaded assets
      id: verify
      run: |
        echo "Downloaded release assets:"
        ls -lh release-assets/ || true
        
        # Check if any files were downloaded
        FILE_COUNT=$(find release-assets -type f | wc -l)
        echo "Total files downloaded: $FILE_COUNT"
        
        if [ "$FILE_COUNT" -eq 0 ]; then
          echo "âŒ ERROR: No release assets were found in release ${{ needs.check-workflow.outputs.release_tag }}"
          echo "Make sure the Build Bindings workflow has completed and uploaded assets to the release."
          exit 1
        fi
        
        echo "âœ… Found $FILE_COUNT release asset(s)"
    
    - name: Re-upload as workflow artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: release-assets/

  # Publish C# NuGet package (using pre-built package from release)
  publish-csharp:
    if: |
      needs.check-workflow.outputs.should_run == 'true' &&
      (github.event_name == 'workflow_run' || github.event.inputs.publish_csharp == 'true')
    needs: [check-workflow, download-release-assets]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: packages/
    
    - name: Publish to NuGet
      run: |
        NUPKG=$(find packages -name "*.nupkg" | head -n 1)
        if [ -z "$NUPKG" ]; then
          echo "âŒ No NuGet package found in release"
          exit 1
        fi
        
        echo "Publishing: $NUPKG"
        dotnet nuget push "$NUPKG" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  # Publish Web npm packages (using pre-built packages from release)
  publish-web:
    if: |
      needs.check-workflow.outputs.should_run == 'true' &&
      (github.event_name == 'workflow_run' || github.event.inputs.publish_web == 'true')
    needs: [check-workflow, download-release-assets]
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: packages/
    
    - name: Publish web packages to npm
      run: |
        # Find and publish all web-related .tgz packages
        for pkg in packages/*-core-*.tgz packages/*-bundler-*.tgz packages/*-node-*.tgz; do
          if [ -f "$pkg" ]; then
            echo "Publishing: $(basename $pkg)"
            npm publish "$pkg" --access public
          fi
        done
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish React Native npm package (using pre-built package from release)
  publish-react-native:
    if: |
      needs.check-workflow.outputs.should_run == 'true' &&
      (github.event_name == 'workflow_run' || github.event.inputs.publish_react_native == 'true')
    needs: [check-workflow, download-release-assets]
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages
        path: packages/
    
    - name: Publish React Native package to npm
      run: |
        RN_PKG=$(find packages -name "*react-native*.tgz" | head -n 1)
        if [ -z "$RN_PKG" ]; then
          echo "âŒ No React Native package found in release"
          exit 1
        fi
        
        echo "Publishing: $(basename $RN_PKG)"
        npm publish "$RN_PKG" --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Publish Rust crate to crates.io
  publish-crates-io:
    if: |
      needs.check-workflow.outputs.should_run == 'true' &&
      (github.event_name == 'workflow_run' || github.event.inputs.publish_crates_io == 'true')
    needs: [check-workflow]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Summary
  publish-summary:
    if: always()
    needs: [check-workflow, download-release-assets, publish-csharp, publish-web, publish-react-native, publish-crates-io]
    runs-on: ubuntu-latest
    
    steps:
    - name: Publish Summary
      run: |
        echo "## ðŸ“¦ Publish Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Tag" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ **${{ needs.check-workflow.outputs.release_tag }}**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
        echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| C# NuGet | ${{ needs.publish-csharp.result == 'success' && 'âœ…' || needs.publish-csharp.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Web npm | ${{ needs.publish-web.result == 'success' && 'âœ…' || needs.publish-web.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| React Native npm | ${{ needs.publish-react-native.result == 'success' && 'âœ…' || needs.publish-react-native.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Rust crates.io | ${{ needs.publish-crates-io.result == 'success' && 'âœ…' || needs.publish-crates-io.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Note" >> $GITHUB_STEP_SUMMARY
        echo "All packages are published from pre-built artifacts in GitHub Release ${{ needs.check-workflow.outputs.release_tag }}." >> $GITHUB_STEP_SUMMARY
